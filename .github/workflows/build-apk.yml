name: Build APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      COMPILE_SDK_VERSION: "34"
      BUILD_TOOLS_VERSION: "34.0.0"
      NDK_VERSION: "25.1.8937393"
      PYTHONVER: "3.10"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python ${{ env.PYTHONVER }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHONVER }}

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git zip unzip python3 python3-pip python3-venv python3-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libsqlite3-dev libbz2-dev libffi-dev libssl-dev libtool autoconf \
          libtool-bin pkg-config libpng-dev libxml2-dev libxslt1-dev libz-dev \
          cmake make g++ libncurses6 zlib1g-dev libcurl4-openssl-dev

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install cython==0.29.33 buildozer virtualenv

    - name: Add tools to PATH
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: |
          platform-tools
          platforms;android-34
          build-tools;34.0.0
          ndk;25.1.8937393
          cmake;3.22.1

    - name: Accept Android licenses (guaranteed method)
      run: | 
        ( sleep 2 && while [ 1 ]; do sleep 1; echo "y"; done ) | sdkmanager --licenses --verbose 2>&1 | grep -v "Exception in thread" &
        LICENSE_PID=$!
        wait $LICENSE_PID || true
        
        mkdir -p "$ANDROID_HOME/licenses" || true
        echo -e "\n24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
        echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
        echo -e "\n504667f4c0de7af1a06de9f4b1727b84351f2910" > "$ANDROID_HOME/licenses/intel-android-extra-license"
        
        yes | sdkmanager --licenses --verbose >/dev/null 2>&1 || true
        
        echo "‚úÖ Licenses accepted:"
        ls -la "$ANDROID_HOME/licenses" || echo "‚ùå No licenses directory"
        sdkmanager --list_installed | grep -E "(platforms|build-tools|ndk)" || echo "‚ùå SDK packages not visible"
      env:
        ANDROID_HOME: /usr/local/lib/android/sdk
        PATH: $PATH:/usr/local/lib/android/sdk/cmdline-tools/latest/bin:/usr/local/lib/android/sdk/platform-tools
      continue-on-error: true

    - name: Clear previous builds
      run: rm -rf .buildozer bin

    - name: Show environment info
      run: |
        echo "=== Environment Info ==="
        python --version
        pip --version
        cython --version
        buildozer --version
        echo "ANDROID_HOME=$ANDROID_HOME"
        echo "Available NDK versions:"
        ls -la $ANDROID_HOME/ndk || echo "No NDK directory"
        sdkmanager --list_installed | grep -E "(ndk|platforms;android-34|build-tools)" || echo "SDK manager not available"

    - name: Initialize Buildozer
      run: |
        echo "=== Initializing Buildozer ==="
        buildozer init
        cat buildozer.spec | grep -v "^#" | grep -v "^$"

    - name: Debug Buildozer config
      run: |
        echo "=== Debugging Buildozer config ==="
        buildozer --verbose android debug --no-compile || true
        echo "=== Buildozer config status: $?"

    - name: Build APK with extreme verbosity
      id: build_apk
      run: |
        echo "=== STARTING FULL APK BUILD ==="
        set -x  # –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
        buildozer --verbose android debug
        set +x
        echo "=== BUILD COMPLETED WITH EXIT CODE $? ==="
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏
        echo "=== FILE STRUCTURE AFTER BUILD ==="
        find . -name "*.apk" -exec ls -la {} \; || echo "No APK files found"
        echo "=== BIN DIRECTORY CONTENTS ==="
        ls -la bin/ || echo "bin/ directory empty"
        echo "=== BUILDOZER PLATFORM STRUCTURE ==="
        find .buildozer/android/platform -maxdepth 3 -type d || echo "No platform structure"

    - name: Save ALL build files for debugging
      uses: actions/upload-artifact@v4
      with:
        name: full-build-debug-${{ github.run_number }}
        path: |
          ./.buildozer
          ./bin
          ./*.log
          ./buildozer.spec
        retention-days: 7
      if: always()

    - name: Final APK search and upload
      id: find_apk
      run: |
        echo "üîç FINAL APK SEARCH"
        APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
        
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå CRITICAL: Still no APK file found!"
          echo "Possible causes:"
          echo "1. Buildozer configuration error"
          echo "2. Python-for-android bootstrap failure"
          echo "3. Missing dependencies in build environment"
          echo "4. Version incompatibility between components"
          echo ""
          echo "Check the 'full-build-debug' artifact for detailed logs"
          exit 1
        fi
        
        echo "‚úÖ FOUND APK AT: $APK_PATH"
        echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
        echo "APK_SIZE=$(du -h $APK_PATH | cut -f1)" >> $GITHUB_OUTPUT
        
        # –ö–æ–ø–∏—Ä—É–µ–º APK –≤ –∫–æ—Ä–µ–Ω—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        mkdir -p release
        cp "$APK_PATH" release/
        echo "Copied APK to release/ directory"

    - name: Upload final APK
      uses: actions/upload-artifact@v4
      with:
        name: psuchecker-apk-${{ github.run_number }}
        path: release/*.apk
        retention-days: 30
      if: always()